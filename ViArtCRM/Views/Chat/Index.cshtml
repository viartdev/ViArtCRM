@model ViArtCRM.Models.GroupContainer
@{
    ViewData["Title"] = "Chat";
}

<script type="text/javascript">

    var currentGroup;
    $(document).ready(function () {

        RefreshGroup();
        UpdateSendButton();

    });


    $('.messageInput').keypress(function (event) {

        var keycode = (event.keyCode ? event.keyCode : event.which);
        if (keycode == '13') {

            alert('You pressed a "enter" key in textbox');  
        }
});


    function RefreshGroup() {
        var containerName = "messages-box";
        var string = '@Url.Action("LoadGroup","Chat")';
        $('.' + containerName).load(string, successFunction);
        console.log("refresh");
    }

    function successFunction() {
        console.log("success");
        GroupMessagesClick();
    }

     function successFunctionA() {
         console.log("successA");
        refreshGroupLastMessage();

    }
    function RefreshCurrentGroup(currentGroup) {
        var groupID = currentGroup;
        var containerName = "chat-box";
        var string = '@Url.Action("LoadMessages","Chat")?groupID=' + groupID;
        var currentGroup = groupID;
        $('.' + containerName).load(string, successFunctionA);
        scrollDown();
    }

    function GroupMessagesClick() {
        $('.groupclick').on('click', function () {
            var groupID = $(this).data('groupid');
            var containerName = "chat-box";
            var string = '@Url.Action("LoadMessages","Chat")?groupID=' + groupID;
            currentGroup = groupID;
         
            $('.' + containerName).load(string, successFunctionA);
            scrollDown();
             
        });
    }
    function enterPressed() {
        $('#someTextBox').keypress(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13'){
            alert('You pressed a "enter" key in textbox');  
    }
});
    }
    function scrollDown() {
        $('.chat-box').animate({scrollTop:$(".chat-box").offset().top + $(".chat-box")[0].scrollHeight});
    }

    function UpdateSendButton() {
        $('#button-addon2').click(function (e) {
            Send(e);

        });
    }
    function Send(event) {
        event.preventDefault();
        var message = $(".messageInput").val();
        console.log("click");
        var data = {
            userID: @ViewBag.userID,
            groupID: currentGroup,
            messageText:  message

        };
            $.ajax({
                url: '/Chat/SendMessage',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: "application/json",
                dataType: 'json',
                error: function (xhr) {
                    alert('Error: ' + xhr.statusText);
                },
                success: function (result) {
                    RefreshCurrentGroup(currentGroup);
                    
                },
                async: true,
                processData: false
            });
    }
    function refreshGroupLastMessage() {

        var lastID = $(".ListMessages").last().data("messageid");
        var groupID = $(".ListMessages").last().data("groupid");

        var data = {
            messageID: lastID,
            groupID: groupID,
        };
        $.ajax({
            url: '/Chat/RefreshGroupLastMessage',
            type: 'POST',
            data: JSON.stringify(data),
            contentType: "application/json",
            dataType: 'json',
            error: function (xhr) {
                alert('Error: ' + xhr.statusText);
            },
            success: function (result) {
                RefreshGroup();
                //RefreshCurrentGroup(currentGroup);
            },
            async: true,
            processData: false
        });
    }
</script>

<div class="container py-5 px-4">
    <!-- For demo purpose-->
    <header class="text-center">
        <h1 class="display-4 text-white">Bootstrap Chat</h1>
        <p class="text-white lead mb-0">An elegant chat widget compatible with Bootstrap 4</p>
        <p class="text-white lead mb-4">
            Snippet by
            <a href="https://bootstrapious.com" class="text-white">
                <u>Bootstrapious</u>
            </a>
        </p>
    </header>

    <div class="row rounded-lg overflow-hidden shadow">
        <!-- Users box-->

        
        <div class="col-5 px-0">
            <div class="bg-white">

                <div class="bg-gray px-4 py-2 bg-light">
                    <p class="h5 mb-0 py-1">Recent</p>
                </div>

                <div class="messages-box">



                  




                    </div>
            </div>
        </div>

        <!-- Chat Box-->
        <div class="col-7 px-0">
            <div class="px-4 py-5 chat-box bg-white">







            </div>

            <!-- Typing area -->
            <form class="bg-light" onsubmit="Send();">
                <div class="input-group">
                    <input type="text" placeholder="Type a message"  class="form-control rounded-0 border-0 py-4 bg-light messageInput">
                    <div class="input-group-append">
                        <button id="button-addon2" type="button" class="btn btn-link messageButton"> Send </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>